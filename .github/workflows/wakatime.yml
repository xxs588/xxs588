name: WakaTime Stats
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Fetch WakaTime Data
        run: |
          curl -H "Authorization: Basic $(echo -n ${{ secrets.WAKATIME_API_KEY }} | base64)" \
            "https://wakatime.com/api/v1/users/current/stats/last_7_days" > waka.json
      - name: Generate Stats Card
        uses: actions/github-script@v7
        with:
          script: |
            const data = require('./waka.json');
            const stats = `## ðŸ•’ Coding Stats
            ${Object.entries(data.data.languages).map(lang => `- ${lang[0]}: ${lang[1].text}`).join('\n')}
            Total: ${data.data.human_readable_total}`;
            const readme = await fs.readFile('README.md', 'utf8');
            const newReadme = readme.replace(
              /<!--START_SECTION:waka-->([\s\S]*)<!--END_SECTION:waka-->/,
              `<!--START_SECTION:waka-->\n${stats}\n<!--END_SECTION:waka-->`
            );
            await fs.writeFile('README.md', newReadme);
      - name: Commit Changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Update WakaTime stats" || echo "No changes to commit"
          git push
